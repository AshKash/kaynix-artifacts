import{BaseSiteAdapter}from"./base-adapter.js";export class AllbirdscomAdapter extends BaseSiteAdapter{constructor(e={}){super("allbirds.com",e)}deduplicateFilters(e){const t=new Set;return e.filter(e=>{const s=e.value||e.label;return!t.has(s)&&(t.add(s),!0)})}categorizeFilter(e,t){const s=e.toLowerCase(),r=t.toLowerCase();if(/^\d+(\.\d+)?$/.test(t)||/^(xs|s|m|l|xl|xxl|xxxl)$/i.test(t))return"size";if(["black","white","red","blue","green","yellow","orange","purple","pink","gray","grey","brown","navy","beige"].some(e=>s.includes(e)||r.includes(e)))return"color";if(["wool","cotton","canvas","leather","suede","mesh","knit"].some(e=>s.includes(e)||r.includes(e)))return"material";return["running","walking","everyday","weather","travel"].some(e=>s.includes(e)||r.includes(e))?"utility":"other"}async search(e,t={}){try{const t=`https://www.allbirds.com/search?q=${encodeURIComponent(e)}`;window.location.href=t,await this.sleep(3e3);const s=await this.extractProducts();return{success:!0,message:`Found ${s.products.length} results for '${e}'`,query:e,products:s.products,count:s.products.length}}catch(s){return{success:!1,message:`Search failed: ${s.message}`,query:e,products:[],count:0}}}async extractProducts(e={}){try{await this.sleep(1e3);const e=document.querySelector('main, [role="main"], .main-content')||document.body,t=e.querySelectorAll("[data-product-card]");if(0===t.length){const t=e.querySelectorAll('a[href*="/products/"]');if(0===t.length)return{success:!1,message:"No products found on page",products:[]};const s=new Map;t.forEach(e=>{let t=e.parentElement,r=0;for(;t&&r<5;){const c=null!==t.querySelector("img"),o=t.textContent.includes("$"),i=t.querySelectorAll('a[href*="/products/"]').length;if(c&&o&&1===i){s.set(t,e);break}t=t.parentElement,r++}});const r=[];let c=0;return s.forEach((e,t)=>{try{const s=this.extractProductFromContainer(t,e,++c);s&&r.push(s)}catch(s){}}),{success:!0,message:`Found ${r.length} products`,products:r}}const s=[];return t.forEach((e,t)=>{try{const r=this.extractProductFromCard(e,t+1);r&&s.push(r)}catch(r){}}),{success:!0,message:`Found ${s.length} products`,products:s}}catch(t){return{success:!1,message:`Failed to extract products: ${t.message}`,products:[]}}}extractProductFromCard(e,t){const s=e.querySelector('a[href*="/products/"]');if(!s)return null;const r=s.getAttribute("href"),c=r.startsWith("http")?r:`${window.location.origin}${r}`;let o="Unknown Product";const i=e.querySelector("h3");if(i)o=this.extractText(i);else{const t=e.querySelectorAll("h1, h2, h4, h5, h6, p, span");for(const e of t){const t=this.extractText(e);if(t&&!t.includes("$")&&t.length>3&&"NEW"!==t&&"BESTSELLER"!==t&&"SALE"!==t&&!t.match(/^\d+(\.\d+)?$/)){o=t;break}}}let a=null;const l=e.querySelectorAll("*");for(const u of l){const e=u.textContent.trim();if(e.match(/^\$\d+/)&&0===u.children.length){a=e;break}}const n=e.querySelector("img");return{title:o,link:c,price:a,image:n?n.src||n.dataset.src||n.srcset?.split(" ")[0]:null,brand:"Allbirds",available:!0,position:t}}extractProductFromContainer(e,t,s){const r=t.getAttribute("href"),c=r.startsWith("http")?r:`${window.location.origin}${r}`;let o="Unknown Product";const i=e.querySelectorAll("h1, h2, h3, h4, h5, h6, p, span");for(const u of i){const e=this.extractText(u);if(e&&!e.includes("$")&&e.length>3){o=e;break}}let a=null;const l=e.querySelectorAll("*");for(const u of l){const e=u.textContent.trim();if(e.match(/^\$\d+/)&&0===u.children.length){a=e;break}}const n=e.querySelector("img");return{title:o,link:c,price:a,image:n?n.src||n.dataset.src||n.srcset?.split(" ")[0]:null,brand:"Allbirds",available:!0,position:s}}async applyFilters(e){try{let t=0;const s=[];if(e.sizes&&e.sizes.length>0)for(const r of e.sizes){const e=await this.findCheckboxByText(r);e&&!e.checked&&(await this.safeClick(e),t++,s.push({type:"size",value:r}),await this.sleep(500))}if(e.colors&&e.colors.length>0)for(const r of e.colors){const e=await this.findCheckboxByText(r);e&&!e.checked&&(await this.safeClick(e),t++,s.push({type:"color",value:r}),await this.sleep(500))}if(e.brands&&e.brands.length>0)for(const r of e.brands){const e=await this.findCheckboxByText(r);e&&!e.checked&&(await this.safeClick(e),t++,s.push({type:"brand",value:r}),await this.sleep(500))}await this.waitForProductUpdate();return{success:!0,message:`Applied ${t} filters`,filtersApplied:t,appliedFilters:s,products:(await this.extractProducts()).products}}catch(t){return{success:!1,message:`Failed to apply filters: ${t.message}`,filtersApplied:0,appliedFilters:[],products:[]}}}async extractAvailableFilters(){const e={brands:[],colors:[],sizes:[],priceRanges:[]};try{const t=document.querySelectorAll("details");for(const s of t){const t=s.querySelector("summary");if(!t)continue;const r=this.extractText(t).toLowerCase();if(r.includes("sort"))continue;s.hasAttribute("open")||(await this.safeClick(t),await this.sleep(500));const c=s.querySelectorAll('input[type="checkbox"]');for(const o of c){const t=o.closest("label")||s.querySelector(`label[for="${o.id}"]`);let c=this.extractText(t);if(!c||c.toLowerCase().includes("cookie"))continue;!r.includes("color")||c&&""!==c||(c=o.value);const i={label:c,value:o.value||c,isChecked:o.checked,count:this.extractCountFromLabel(c)};if(r.includes("size"))e.sizes.push(i);else if(r.includes("color"))e.colors.push(i);else if(r.includes("material"))e.brands.push(i);else if(r.includes("type"))e.brands.push(i);else if(r.includes("utility"))e.brands.push(i);else{switch(this.categorizeFilter(c,o.value)){case"size":e.sizes.push(i);break;case"color":e.colors.push(i);break;default:e.brands.push(i)}}}}return e.brands=this.deduplicateFilters(e.brands),e.colors=this.deduplicateFilters(e.colors),e.sizes=this.deduplicateFilters(e.sizes),e.priceRanges=this.deduplicateFilters(e.priceRanges),e}catch(t){return e}}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on allbirds.com",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query"}},required:["query"]}},{name:"get_page_products",description:"Extract products from current page",inputSchema:{type:"object",properties:{}}},{name:"get_available_filters",description:"Get available filters on current page",inputSchema:{type:"object",properties:{}}},{name:"apply_filters",description:"Apply filters to product listing",inputSchema:{type:"object",properties:{filters:{type:"object",description:"Filters to apply (e.g. {sizes: ['M'], colors: ['Blue']})"}},required:["filters"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return this.search(t.query);case"get_page_products":return this.extractProducts();case"get_available_filters":return this.extractAvailableFilters();case"apply_filters":return this.applyFilters(t.filters);default:throw new Error(`Unknown MCP tool: ${e}`)}}}export default AllbirdscomAdapter;