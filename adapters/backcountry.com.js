import{BaseSiteAdapter}from"./base-adapter.js";export class BackcountryAdapter extends BaseSiteAdapter{constructor(t={}){super("backcountry.com",t)}extractFromNextData(){this.log("Attempting to extract from __NEXT_DATA__...");const t=[],r=document.getElementById("__NEXT_DATA__");if(!r)return this.log("No __NEXT_DATA__ script found"),t;try{const e=JSON.parse(r.textContent),c=e?.props?.pageProps;if(!c)return this.log("No pageProps found in __NEXT_DATA__"),t;const o=c?.searchResults||c?.products||c?.initialData?.products||c?.productList;if(Array.isArray(o))for(const r of o){const e={title:r.displayName||r.name||r.title,url:r.url||(r.slug?`/p/${r.slug}`:null),price:r.price||r.salePrice||r.regularPrice,imageUrl:r.image||r.imageUrl||r.primaryImageUrl,brand:r.brand||r.brandName,sku:r.sku||r.id};e.title&&e.price&&(e.url&&!e.url.startsWith("http")&&(e.url=`https://www.backcountry.com${e.url}`),t.push(e))}}catch(e){this.log("Error parsing __NEXT_DATA__:",e)}return this.log(`Extracted ${t.length} products from __NEXT_DATA__`),t}async extractProducts(t={}){this.log("Extracting products from backcountry.com...");let r=[];const e=this.extractFromNextData();if(e.length>0&&(this.log(`Found ${e.length} products from __NEXT_DATA__`),r=e),0===r.length){this.log("No __NEXT_DATA__ products found, trying DOM extraction...");const t=["div.css-1a5a5hj",'[data-testid="product-card"]','[data-testid="plp-product-tile"]','article[class*="product"]','div[class*="ProductCard"]','div[class*="product-tile"]','li[class*="product"]'];for(const e of t){const t=document.querySelectorAll(e);if(t.length>0){this.log(`Found ${t.length} elements with selector: ${e}`);for(const e of t)try{const t={},c=['[data-id="title"]','[data-testid="product-title"]','a[href*="/p/"]',"h2","h3","h4",'[class*="title"]','[class*="name"]'];for(const r of c){const c=e.querySelector(r);if(c){t.title=c.textContent.trim(),"A"===c.tagName&&(t.url=c.href);break}}if(!t.url){const r=e.querySelector('a[href*="/p/"]');r&&(t.url=r.href)}const o=['[data-id="price"]','[data-testid="product-price"]','[class*="price"]','span[class*="Price"]'];for(const r of o){const c=e.querySelector(r);if(c){const r=c.textContent.trim();if(t.price=this.extractPrice(r),t.price)break}}const i=['img[data-id="product-image"]','img[data-testid="product-image"]','img[alt*="product"]','img[src*="backcountry"]',"img"];for(const r of i){const c=e.querySelector(r);if(c&&(t.imageUrl=c.src||c.getAttribute("data-src"),t.imageUrl))break}t.title&&t.price?r.push(t):this.log("Skipping product with missing fields:",{title:t.title,price:t.price,url:t.url})}catch(c){this.error("Error extracting product:",c)}if(r.length>0)break}}}if(0===r.length){this.log("Still no products found, trying generic extraction...");const t=document.querySelectorAll('a[href*="/p/"], a[href*="/product/"]');this.log(`Found ${t.length} potential product links`);for(const e of t)try{const t=e.closest("article, li, div");if(!t)continue;const c={title:e.textContent.trim(),url:e.href},o=t.querySelector('[class*="price"], span[data-price]');o&&(c.price=this.extractPrice(o.textContent));const i=t.querySelector("img");i&&(c.imageUrl=i.src||i.getAttribute("data-src")),c.title&&c.price&&r.push(c)}catch(c){this.log("Error in generic extraction:",c)}}return this.log(`Extracted ${r.length} products total`),{products:r,success:!0}}}