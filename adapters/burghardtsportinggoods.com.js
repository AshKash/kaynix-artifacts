import{BaseSiteAdapter,STANDARD_MCP_TOOLS,ProductJsonLD,MCPResponse}from"./base-adapter.js";export default class BurghardtsportinggoodscomAdapter extends BaseSiteAdapter{constructor(e={}){super("burghardtsportinggoods.com",e),this.debug=e.debug||!1,this.selectors={filters:{collapsibleWrapper:".collapsible-icon-wrapper[data-collapsible]",filterTrigger:"[data-collapsible-trigger]",filterContainer:"[data-collapsible-id]",filterState:"[data-collapsible-enabled-state]",checkboxFilters:{size:'input[name^="filter.v.option.size"]',color:'input[name^="filter.v.option.color"]',brand:'input[name^="filter.v.vendor"]',price:'input[name^="filter.v.price"]',productType:'input[name^="filter.p.product_type"]',tag:'input[name^="filter.p.tag"]',material:'input[name^="filter.v.option.material"]',style:'input[name^="filter.v.option.style"]',team:'input[name^="filter.v.option.team"]',player:'input[name^="filter.v.option.player"]'},priceInputs:{min:'input[name="filter.v.price.gte"]',max:'input[name="filter.v.price.lte"]'}},products:{grid:".productGrid",gridItem:".productGrid .product",card:".card",cardLink:".card-figure__link",title:".card-title a",price:".price--withoutTax",priceSection:".price-section--withoutTax",image:".card-image",brand:'.card-text[data-test-info-type="brandName"]',addToCart:'.card-figcaption-button[data-button-type="add-cart"]',chooseOptions:'.card-figcaption-button:contains("Choose Options")',quickView:".button.quickview[data-product-id]",productId:'[data-test^="card-"]',imageContainer:".card-img-container"},search:{quickSearchButton:".navUser-action--quickSearch",quickSearchDropdown:"#quickSearch",searchForm:"[data-quick-search-form]",searchInput:"[data-search-quick]",searchResults:".quickSearchResults",mobileSearchInput:"#nav-menu-quick-search",desktopSearchInput:"#nav-quick-search"},cart:{cartLink:"[data-cart-preview]",cartQuantity:".cart-quantity",cartDropdown:"#cart-preview-dropdown",cartPreview:'[data-dropdown="cart-preview-dropdown"]',addToCartUrl:"/cart.php?action=add&product_id=",cartPageUrl:"/cart.php",cartLabel:".navUser-item-cartLabel"}}}async search(e){try{if(this.page){const t=await this.page.$(this.selectors.search.quickSearchButton);t&&(await t.click(),await this.page.waitForSelector(this.selectors.search.searchInput,{visible:!0}));const r=await this.page.$(this.selectors.search.searchInput);if(!r)return{success:!1,products:[],query:e,error:"Failed to find search input"};await r.fill(e),await r.press("Enter"),await this.waitForPageLoad();return{...await this.extractProducts(),query:e}}{const t=document.querySelector(this.selectors.search.quickSearchButton);t&&(t.click(),await new Promise(e=>setTimeout(e,500)));const r=document.querySelector(this.selectors.search.searchInput)||document.querySelector(this.selectors.search.desktopSearchInput)||document.querySelector(this.selectors.search.mobileSearchInput);if(!r)return window.location.href=`/search.php?search_query=${encodeURIComponent(e)}`,{success:!0,products:[],query:e};r.value=e;const s=r.closest("form");return s?s.submit():window.location.href=`/search.php?search_query=${encodeURIComponent(e)}`,{success:!0,products:[],query:e}}}catch(t){return{success:!1,products:[],query:e,error:t.message}}}async applyFilters(e){try{let t=e;"string"==typeof e&&(t=this.parseNaturalLanguageFilters(e));const r=[];if(this.page)for(const[e,s]of Object.entries(t)){const t=this.selectors.filters.checkboxFilters[e];if(t)if("priceMax"===e||"priceMin"===e){const t="priceMax"===e?this.selectors.filters.priceInputs.max:this.selectors.filters.priceInputs.min,a=await this.page.$(t);a&&(await a.fill(s.toString()),r.push({type:e,value:s}))}else{const a=await this.page.$$(t);for(const t of a){const a=await t.getAttribute("value"),i=await t.evaluateHandle(e=>{const t=e.getAttribute("id");return document.querySelector(`label[for="${t}"]`)?.textContent?.trim()}),c=await i.jsonValue();if(a?.toLowerCase()===s.toLowerCase()||c?.toLowerCase().includes(s.toLowerCase())){await t.click(),r.push({type:e,value:s});break}}}}else for(const[e,s]of Object.entries(t)){const t=this.selectors.filters.checkboxFilters[e];if(t)if("priceMax"===e||"priceMin"===e){const t="priceMax"===e?this.selectors.filters.priceInputs.max:this.selectors.filters.priceInputs.min,a=document.querySelector(t);a&&(a.value=s.toString(),a.dispatchEvent(new Event("change",{bubbles:!0})),r.push({type:e,value:s}))}else{const a=document.querySelectorAll(t);for(const t of a){const a=t.value,i=document.querySelector(`label[for="${t.id}"]`),c=i?.textContent?.trim();if(a?.toLowerCase()===s.toLowerCase()||c?.toLowerCase().includes(s.toLowerCase())){t.click(),r.push({type:e,value:s});break}}}}await this.waitForPageLoad();return{...await this.extractProducts(),appliedFilters:r}}catch(t){return{success:!1,appliedFilters:[],products:[],error:t.message}}}async extractProducts(){try{if(this.page){return{success:!0,products:await this.page.evaluate(e=>{const t=document.querySelectorAll(e.products.gridItem);return Array.from(t).map(t=>{const r=t.querySelector(e.products.title),s=t.querySelector(e.products.price),a=t.querySelector(e.products.image),i=t.querySelector(e.products.cardLink),c=t.querySelector(e.products.brand),o=t.querySelector(e.products.productId);let n="";if(s){const e=s.textContent.match(/\$[\d,]+\.?\d*/);n=e?e[0]:s.textContent.trim()}return{title:r?.textContent?.trim()||"",price:n,image:a?.src||a?.dataset?.src||"",link:i?.href||"",brand:c?.textContent?.trim()||"",id:o?.dataset?.test?.replace("card-","")||"",inStock:!t.textContent.toLowerCase().includes("out of stock")}}).filter(e=>e.title)},this.selectors)}}{const e=document.querySelectorAll(this.selectors.products.gridItem);return{success:!0,products:Array.from(e).map(e=>{const t=e.querySelector(this.selectors.products.title),r=e.querySelector(this.selectors.products.price),s=e.querySelector(this.selectors.products.image),a=e.querySelector(this.selectors.products.cardLink),i=e.querySelector(this.selectors.products.brand),c=e.querySelector(this.selectors.products.productId);let o="";if(r){const e=r.textContent.match(/\$[\d,]+\.?\d*/);o=e?e[0]:r.textContent.trim()}return{title:t?.textContent?.trim()||"",price:o,image:s?.src||s?.dataset?.src||"",link:a?.href||"",brand:i?.textContent?.trim()||"",id:c?.dataset?.test?.replace("card-","")||"",inStock:!e.textContent.toLowerCase().includes("out of stock")}}).filter(e=>e.title)}}}catch(e){return{success:!1,products:[],error:e.message}}}async addToCart(e,t={}){try{const t=e.id||this.extractProductId(e.link);if(!t)return{success:!1,message:"Product ID not found"};if(this.page){const e=await this.page.$(`[data-product-id="${t}"] ${this.selectors.products.addToCart}`);return e?(await e.click(),await this.page.waitForTimeout(1e3),{success:!0,message:"Product added to cart"}):(await this.page.goto(`${this.selectors.cart.addToCartUrl}${t}`),{success:!0,message:"Product added to cart"})}return window.location.href=`${this.selectors.cart.addToCartUrl}${t}`,{success:!0,message:"Product added to cart"}}catch(r){return{success:!1,message:r.message}}}async waitForPageLoad(){this.page?(await this.page.waitForLoadState("networkidle"),await this.page.waitForTimeout(1e3)):await new Promise(e=>setTimeout(e,1e3))}async getAvailableFilters(){try{const e={};if(this.page)e.sizes=await this.page.$$eval(this.selectors.filters.checkboxFilters.size,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean)),e.colors=await this.page.$$eval(this.selectors.filters.checkboxFilters.color,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean)),e.brands=await this.page.$$eval(this.selectors.filters.checkboxFilters.brand,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean)),e.productTypes=await this.page.$$eval(this.selectors.filters.checkboxFilters.productType,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean)),e.teams=await this.page.$$eval(this.selectors.filters.checkboxFilters.team,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean)),e.players=await this.page.$$eval(this.selectors.filters.checkboxFilters.player,e=>e.map(e=>e.value||e.nextElementSibling?.textContent?.trim()).filter(Boolean));else{const t=e=>Array.from(document.querySelectorAll(e)).map(e=>e.value||document.querySelector(`label[for="${e.id}"]`)?.textContent?.trim()).filter(Boolean);e.sizes=t(this.selectors.filters.checkboxFilters.size),e.colors=t(this.selectors.filters.checkboxFilters.color),e.brands=t(this.selectors.filters.checkboxFilters.brand),e.productTypes=t(this.selectors.filters.checkboxFilters.productType),e.teams=t(this.selectors.filters.checkboxFilters.team),e.players=t(this.selectors.filters.checkboxFilters.player)}return e.priceRange={min:0,max:500},e}catch(e){return{}}}parseNaturalLanguageFilters(e){const t={},r=e.toLowerCase(),s=r.match(/size\s+(\w+)|(\w+)\s+size|^(xs|s|m|l|xl|xxl|xxxl|\d+)$/i);s&&(t.size=(s[1]||s[2]||s[3]).toUpperCase());const a=r.match(/(\w+)\s+color|color\s+(\w+)|(red|blue|black|white|green|yellow|orange|purple|pink|gray|grey)/i);a&&(t.color=(a[1]||a[2]||a[3]).toLowerCase());const i=r.match(/under\s+\$?(\d+)|less\s+than\s+\$?(\d+)|below\s+\$?(\d+)/i);i&&(t.priceMax=parseInt(i[1]||i[2]||i[3]));const c=["nike","adidas","puma","reebok","under armour","new balance"];for(const o of c)if(r.includes(o)){t.brand=o;break}return t}extractProductId(e){const t=e?.match(/products\/([^/?]+)/);return t?t[1]:null}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for sporting goods and equipment",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query"}},required:["query"]}},{name:"filter_products",description:"Filter products by size, color, brand, price, team, player, etc.",inputSchema:{type:"object",properties:{filters:{type:"object",description:"Filter criteria",properties:{size:{type:"string"},color:{type:"string"},brand:{type:"string"},priceMax:{type:"number"},priceMin:{type:"number"},team:{type:"string"},player:{type:"string"},productType:{type:"string"}}}},required:["filters"]}},{name:"get_page_products",description:"Get products currently displayed on the page",inputSchema:{type:"object",properties:{}}},{name:"add_to_cart",description:"Add a product to the shopping cart",inputSchema:{type:"object",properties:{product:{type:"object",description:"Product to add",properties:{id:{type:"string"},link:{type:"string"}}}},required:["product"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return await this.search(t.query);case"filter_products":return await this.applyFilters(t.filters);case"get_page_products":return await this.extractProducts();case"add_to_cart":return await this.addToCart(t.product);default:return{success:!1,error:`Unknown tool: ${e}`}}}}