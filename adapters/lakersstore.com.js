import{BaseSiteAdapter,STANDARD_MCP_TOOLS,ProductJsonLD,MCPResponse}from"./base-adapter.js";export default class LakersstorecomAdapter extends BaseSiteAdapter{constructor(e={}){super("lakersstore.com",e),this.debug=e.debug||!1,this.selectors={filters:{form:".filter-form",collapsibleTrigger:".collapsible-trigger",collapsibleContent:".collapsible-content",priceRange:{container:".price-range",slider:".price-range__slider",minInput:".price-range__input-min",maxInput:".price-range__input-max",displayMin:".price-range__display-min",displayMax:".price-range__display-max"},checkboxFilters:{productType:'input[name="filter.p.product_type"]',color:'input[name="filter.p.m.custom.color"]',size:'input[name="filter.v.option.size"]',players:'input[name="filter.p.m.custom.players"]'},filterGroups:{container:".collection-sidebar__group",header:".tag-list__header",checkbox:".tag__checkbox",text:".tag__text"}},products:{grid:".grid.grid--uniform",item:".grid__item.grid-product",dataAttributes:{handle:"[data-product-handle]",id:"[data-product-id]"},content:".grid-product__content",image:".grid__item-image-wrapper",price:{container:".grid-product__price",original:".grid-product__price--original",savings:".grid-product__price--savings"},quickShop:{button:".quick-product__btn",modalTrigger:'[class*="js-modal-open-quick-modal-"]'}},search:{container:".site-header__search-container",form:".site-header__search",inputWrapper:".search__input-wrap",input:"#Search",inputClass:".search__input",searchButton:".btn--search",closeButton:".btn--close-search",predictiveSearch:"#predictive-search",results:".search__results",headerLinks:".js-search-header"},navigation:{desktop:{nav:".site-nav",item:".site-nav__item",link:".site-nav__link",dropdown:".site-nav__dropdown",megamenu:".megamenu",dropdownLink:".site-nav__dropdown-link"},mobile:{nav:".mobile-nav",item:".mobile-nav__item",link:".mobile-nav__link",toggle:".mobile-nav__toggle",sublist:".mobile-nav__sublist",drawerTrigger:".js-drawer-open-nav"}},cart:{drawer:{container:"#CartDrawer",form:"#CartDrawerForm",trigger:".js-drawer-open-cart",empty:".drawer__cart-empty",header:".drawer__header",title:".drawer__title",close:".drawer__close"},items:{container:".cart__item-sub",row:".cart__item-row"},totals:{subtotal:".ajaxcart__subtotal",total:".bold_cart_total"},checkout:{wrapper:".cart__checkout-wrapper",button:".btn.cart__checkout"},indicators:{link:".cart-link",bubble:".cart-link__bubble"},api:{add:"/cart/add",update:"/cart/update",change:"/cart/change"}},sorting:{container:".collection-filter__item--sort",select:"#SortBy",options:{manual:"manual",bestSelling:"best-selling",titleAsc:"title-ascending",titleDesc:"title-descending",priceAsc:"price-ascending",priceDesc:"price-descending",dateAsc:"created-ascending",dateDesc:"created-descending"}}}}async search(e){try{if(this.page){await this.page.waitForSelector(this.selectors.search.input,{timeout:5e3}),await this.page.fill(this.selectors.search.input,e),await this.page.keyboard.press("Enter"),await this.waitForPageLoad();return{success:!0,products:(await this.extractProducts()).products,query:e}}{const t=document.querySelector(this.selectors.search.input);if(!t)return{success:!1,products:[],query:e,error:"Failed to find search input"};t.value=e;const r=document.querySelector(this.selectors.search.searchButton);if(r)r.click();else{const r=t.closest("form");r?r.submit():window.location.href=`/search?q=${encodeURIComponent(e)}`}await this.waitForPageLoad();return{success:!0,products:(await this.extractProducts()).products,query:e}}}catch(t){return{success:!1,products:[],query:e,error:t.message}}}async applyFilters(e){try{let t=e;"string"==typeof e&&(t=this.parseNaturalLanguageFilters(e));const r=[];for(const[e,a]of Object.entries(t)){if("priceMax"===e||"priceMin"===e){const t="priceMax"===e?this.selectors.filters.priceRange.maxInput:this.selectors.filters.priceRange.minInput;if(this.page)await this.page.fill(t,a.toString());else{const e=document.querySelector(t);e&&(e.value=a.toString(),e.dispatchEvent(new Event("change",{bubbles:!0})))}r.push({type:e,value:a});continue}const t=this.selectors.filters.checkboxFilters[e];if(t)if(this.page){const s=await this.page.$$(t);for(const t of s){const s=await t.getAttribute("value"),i=await this.page.evaluate(e=>{const t=e.closest("label")||document.querySelector(`label[for="${e.id}"]`);return t?t.textContent.trim():""},t);if(this.matchesFilterValue(a,s,i)){await t.click(),r.push({type:e,value:a});break}}}else{const s=document.querySelectorAll(t);for(const t of s){const s=t.value,i=t.closest("label")||document.querySelector(`label[for="${t.id}"]`),c=i?i.textContent.trim():"";if(this.matchesFilterValue(a,s,c)){t.click(),r.push({type:e,value:a});break}}}}await this.waitForPageLoad();return{success:!0,appliedFilters:r,products:(await this.extractProducts()).products}}catch(t){return{success:!1,appliedFilters:[],products:[],error:t.message}}}async extractProducts(){try{if(this.page){return{success:!0,products:await this.page.evaluate(e=>{const t=document.querySelectorAll(e.products.item);return Array.from(t).map(t=>{const r=t.querySelector(e.products.content);if(!r)return null;const a=r.querySelector(".grid-product__title"),s=r.querySelector(".grid-product__link"),i=r.querySelector(e.products.price.container),c=t.querySelector(e.products.image),o=c?c.querySelector("img"):null;let n="N/A";if(i){const e=i.textContent.match(/\$[\d,]+\.?\d*/);e&&(n=e[0])}const l=t.getAttribute("data-product-handle")||"",u=t.getAttribute("data-product-id")||"";return{title:a?a.textContent.trim():"N/A",price:n,url:s?s.href:"#",imageUrl:o?o.src||o.dataset.src:"",handle:l,id:u}}).filter(Boolean)},this.selectors)}}{const e=document.querySelectorAll(this.selectors.products.item);return{success:!0,products:Array.from(e).map(e=>{const t=e.querySelector(this.selectors.products.content);if(!t)return null;const r=t.querySelector(".grid-product__title"),a=t.querySelector(".grid-product__link"),s=t.querySelector(this.selectors.products.price.container),i=e.querySelector(this.selectors.products.image),c=i?i.querySelector("img"):null;let o="N/A";if(s){const e=s.textContent.match(/\$[\d,]+\.?\d*/);e&&(o=e[0])}const n=e.getAttribute("data-product-handle")||"",l=e.getAttribute("data-product-id")||"";return{title:r?r.textContent.trim():"N/A",price:o,url:a?a.href:"#",imageUrl:c?c.src||c.dataset.src:"",handle:n,id:l}}).filter(Boolean)}}}catch(e){return{success:!1,products:[],error:e.message}}}async addToCart(e,t={}){try{const r=t.quantity||1,a=e.id||e.handle;if(!a)return{success:!1,message:"Product ID not found"};const s=new FormData;s.append("id",a),s.append("quantity",r.toString());return(await fetch(this.selectors.cart.api.add,{method:"POST",body:s})).ok?{success:!0,message:"Product added to cart"}:{success:!1,message:"Failed to add product to cart"}}catch(r){return{success:!1,message:r.message}}}async waitForPageLoad(){this.page?(await this.page.waitForLoadState("networkidle",{timeout:1e4}).catch(()=>{}),await this.page.waitForTimeout(1e3)):await new Promise(e=>setTimeout(e,2e3))}async getAvailableFilters(){try{const e={};for(const[a,s]of Object.entries(this.selectors.filters.checkboxFilters))if(this.page){const t=await this.page.evaluate(e=>{const t=document.querySelectorAll(e);return Array.from(t).map(e=>{const t=e.closest("label")||document.querySelector(`label[for="${e.id}"]`);return t?t.textContent.trim():e.value})},s);t.length>0&&(e[a]=t)}else{const t=document.querySelectorAll(s),r=Array.from(t).map(e=>{const t=e.closest("label")||document.querySelector(`label[for="${e.id}"]`);return t?t.textContent.trim():e.value});r.length>0&&(e[a]=r)}const t=document.querySelector(this.selectors.filters.priceRange.minInput),r=document.querySelector(this.selectors.filters.priceRange.maxInput);return t&&r&&(e.priceRange={min:parseFloat(t.min||t.value||0),max:parseFloat(r.max||r.value||500)}),e}catch(e){return{}}}parseNaturalLanguageFilters(e){const t={},r=e.toLowerCase(),a=r.match(/size\s+(\w+)/);a&&(t.size=a[1].toUpperCase());const s=["red","blue","black","white","green","yellow","purple","pink","orange","gray","grey"];for(const o of s)if(r.includes(o)){t.color=o.charAt(0).toUpperCase()+o.slice(1);break}const i=r.match(/under\s+\$?(\d+)/);i&&(t.priceMax=parseInt(i[1]));const c=r.match(/(\w+\s+\w+)\s+(jersey|shirt|gear)/i);return c&&(t.players=c[1]),t}matchesFilterValue(e,t,r){const a=e.toString().toLowerCase(),s=t.toLowerCase(),i=r.toLowerCase();if(s===a||i===a)return!0;const c={small:"s",medium:"m",large:"l","extra large":"xl",red:"rd",blue:"bl",black:"bk"}[a];return c&&(s===c||i.includes(a))}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for Lakers merchandise on the official store",inputSchema:{type:"object",properties:{query:{type:"string",description:'Search query (e.g., "lebron jersey", "purple hoodie")'}},required:["query"]}},{name:"filter_products",description:"Apply filters to narrow down Lakers products",inputSchema:{type:"object",properties:{filters:{type:"object",description:"Filter criteria",properties:{size:{type:"string",description:'Size (e.g., "S", "M", "L", "XL")'},color:{type:"string",description:'Color (e.g., "Purple", "Gold", "Black")'},productType:{type:"string",description:'Product type (e.g., "Jersey", "Shirt", "Hat")'},players:{type:"string",description:'Player name (e.g., "LeBron James", "Anthony Davis")'},priceMin:{type:"number",description:"Minimum price"},priceMax:{type:"number",description:"Maximum price"}}}},required:["filters"]}},{name:"get_page_products",description:"Get all products currently displayed on the page",inputSchema:{type:"object",properties:{},required:[]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return await this.search(t.query);case"filter_products":return await this.applyFilters(t.filters);case"get_page_products":return await this.extractProducts();default:return{success:!1,error:`Unknown tool: ${e}`}}}}