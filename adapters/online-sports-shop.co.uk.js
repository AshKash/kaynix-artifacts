import{BaseSiteAdapter,STANDARD_MCP_TOOLS,ProductJsonLD,MCPResponse}from"./base-adapter.js";export default class OnlineSportsShopcoukAdapter extends BaseSiteAdapter{constructor(e={}){super("online-sports-shop.co.uk",e),this.debug=e.debug||!1,this.selectors={filters:{checkboxFilters:{tag:"#Filter-filter.p.tag-64-no-js",availability:"#Filter-filter.v.availability-1",vendor:"#Filter-filter.p.vendor-18-no-js",product_type:"#Filter-filter.p.product_type-mobile-5",size:'input[name="filter.v.option.size"]',color:'input[name="filter.v.option.color"]',price:'input[name="filter.v.price"]'},container:"#FacetsWrapperDesktop",filterContainers:["#FacetsWrapperDesktop","#main-collection-filters",".facets-container"],trigger:".facets__disclosure",priceInputs:{min:'input[name="filter.v.price.gte"]',max:'input[name="filter.v.price.lte"]'}},products:{grid:".section-template--16816211886313__product-grid-padding",item:".product-card-wrapper",title:".card__heading a",price:".price-item",image:".card__media img",link:".card__heading a",soldOut:'[data-sold-out-message="true"]'},search:{form:".search",input:"#Search-In-Modal",button:".reset__button",searchParam:"q"},cart:{addButton:'[data-sold-out-message="true"]',form:'[data-type="add-to-cart-form"]',productIdInput:'input[name="id"]'}}}async search(e){try{if(this.page){await this.page.waitForSelector(this.selectors.search.input,{timeout:5e3}),await this.page.fill(this.selectors.search.input,e),await this.page.press(this.selectors.search.input,"Enter"),await this.waitForPageLoad();return{success:!0,products:(await this.extractProducts()).products||[],query:e}}{const t=document.querySelector(this.selectors.search.input);if(!t)return{success:!1,products:[],query:e,error:"Search input not found"};const r=t.closest("form");return r?(t.value=e,r.submit()):window.location.href=`/search?${this.selectors.search.searchParam}=${encodeURIComponent(e)}`,{success:!0,products:[],query:e}}}catch(t){return{success:!1,products:[],query:e,error:t.message}}}async applyFilters(e){try{let t=e;"string"==typeof e&&(t=this.parseNaturalLanguageFilters(e));const r=[];if(this.page){for(const[e,s]of Object.entries(t)){const t=this.selectors.filters.checkboxFilters[e];if(t)if("priceMax"===e||"priceMin"===e){const t="priceMax"===e?this.selectors.filters.priceInputs.max:this.selectors.filters.priceInputs.min;await this.page.fill(t,s.toString()),r.push({type:e,value:s})}else{const i=await this.page.$(`${t}[value="${s}"]`)||await this.page.$(`${t}[value="${s.toUpperCase()}"]`)||await this.page.$(`${t}[value="${s.toLowerCase()}"]`);i&&(await i.check(),r.push({type:e,value:s}))}}await this.waitForPageLoad();return{success:!0,appliedFilters:r,products:(await this.extractProducts()).products||[]}}for(const[e,s]of Object.entries(t)){if(this.selectors.filters.checkboxFilters[e])if("priceMax"===e||"priceMin"===e){const t="priceMax"===e?this.selectors.filters.priceInputs.max:this.selectors.filters.priceInputs.min,i=document.querySelector(t);i&&(i.value=s,i.dispatchEvent(new Event("change",{bubbles:!0})),r.push({type:e,value:s}))}else{const t=document.querySelectorAll('input[name^="filter."]');for(const i of t){const t=i.value.toLowerCase(),a=s.toString().toLowerCase();if(t===a||i.parentElement?.textContent?.toLowerCase().includes(a)){i.checked=!0,i.dispatchEvent(new Event("change",{bubbles:!0})),r.push({type:e,value:s});break}}}}return{success:!0,appliedFilters:r,products:[]}}catch(t){return{success:!1,appliedFilters:[],products:[],error:t.message}}}async extractProducts(){try{if(this.page){return{success:!0,products:await this.page.evaluate(e=>{const t=document.querySelectorAll(e.products.item);return Array.from(t).map((t,r)=>{const s=t.querySelector(e.products.title),i=t.querySelector(e.products.price),a=t.querySelector(e.products.image),c=t.querySelector(e.products.link),o=t.querySelector(e.products.soldOut);let n="";if(i){const e=i.textContent.match(/\$[\d,]+\.?\d*/);n=e?e[0]:i.textContent.trim()}return{id:`product-${r}`,title:s?.textContent?.trim()||"",price:n,image:a?.src||a?.dataset?.src||"",link:c?.href||"",available:!o||-1===o.textContent.toLowerCase().indexOf("sold out")}}).filter(e=>e.title)},this.selectors)}}{const e=document.querySelectorAll(this.selectors.products.item);return{success:!0,products:Array.from(e).map((e,t)=>{const r=e.querySelector(this.selectors.products.title),s=e.querySelector(this.selectors.products.price),i=e.querySelector(this.selectors.products.image),a=e.querySelector(this.selectors.products.link),c=e.querySelector(this.selectors.products.soldOut);let o="";if(s){const e=s.textContent.match(/\$[\d,]+\.?\d*/);o=e?e[0]:s.textContent.trim()}return{id:`product-${t}`,title:r?.textContent?.trim()||"",price:o,image:i?.src||i?.dataset?.src||"",link:a?.href||"",available:!c||-1===c.textContent.toLowerCase().indexOf("sold out")}}).filter(e=>e.title)}}}catch(e){return{success:!1,products:[],error:e.message}}}async addToCart(e,t={}){try{if(!e.link)return{success:!1,message:"Product link not available"};if(this.page){await this.page.goto(e.link),await this.page.waitForSelector(this.selectors.cart.addButton,{timeout:5e3});return await this.page.evaluate(e=>{const t=document.querySelector(e);return t&&!t.textContent.toLowerCase().includes("sold out")},this.selectors.cart.addButton)?(await this.page.click(this.selectors.cart.addButton),await this.page.waitForTimeout(2e3),{success:!0,message:"Product added to cart"}):{success:!1,message:"Product is sold out"}}return{success:!1,message:"Cart functionality requires browser context"}}catch(r){return{success:!1,message:r.message}}}async waitForPageLoad(){if(this.page)try{await this.page.waitForLoadState("networkidle",{timeout:1e4})}catch(e){await this.page.waitForTimeout(2e3)}}async getAvailableFilters(){try{const e={sizes:[],colors:[],vendors:[],productTypes:[],tags:[],availability:[],priceRange:{min:0,max:500}};if(this.page)return await this.page.evaluate(e=>{const t={sizes:[],colors:[],vendors:[],productTypes:[],tags:[],availability:[],priceRange:{min:0,max:500}};document.querySelectorAll('input[name^="filter."]').forEach(e=>{const r=e.name,s=e.value,i=e.parentElement?.textContent?.trim()||s;r.includes("size")?t.sizes.push(i):r.includes("color")?t.colors.push(i):r.includes("vendor")?t.vendors.push(i):r.includes("product_type")?t.productTypes.push(i):r.includes("tag")?t.tags.push(i):r.includes("availability")&&t.availability.push(i)});const r=document.querySelector(e.filters.priceInputs?.min),s=document.querySelector(e.filters.priceInputs?.max);return r&&(t.priceRange.min=parseInt(r.min||0)),s&&(t.priceRange.max=parseInt(s.max||500)),t},this.selectors);return document.querySelectorAll('input[name^="filter."]').forEach(t=>{const r=t.name,s=t.value,i=t.parentElement?.textContent?.trim()||s;r.includes("size")&&!e.sizes.includes(i)?e.sizes.push(i):r.includes("color")&&!e.colors.includes(i)?e.colors.push(i):r.includes("vendor")&&!e.vendors.includes(i)?e.vendors.push(i):r.includes("product_type")&&!e.productTypes.includes(i)?e.productTypes.push(i):r.includes("tag")&&!e.tags.includes(i)?e.tags.push(i):r.includes("availability")&&!e.availability.includes(i)&&e.availability.push(i)}),e}catch(e){return{sizes:[],colors:[],vendors:[],productTypes:[],tags:[],availability:[],priceRange:{min:0,max:500}}}}parseNaturalLanguageFilters(e){const t={},r=e.toLowerCase(),s=r.match(/size\s+(\S+)/);s&&(t.size=s[1].toUpperCase());const i=["red","blue","green","black","white","yellow","orange","purple","pink","gray","grey"];for(const o of i)if(r.includes(o)){t.color=o;break}const a=r.match(/under\s+\$?(\d+)/);a&&(t.priceMax=parseInt(a[1]));const c=r.match(/\$?(\d+)\s*-\s*\$?(\d+)/);return c&&(t.priceMin=parseInt(c[1]),t.priceMax=parseInt(c[2])),t}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on online-sports-shop.co.uk",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query for products"}},required:["query"]}},{name:"filter_products",description:"Filter products by various criteria",inputSchema:{type:"object",properties:{filters:{type:"string",description:'Natural language filter query (e.g., "size M blue under $50") or specific filters'}},required:["filters"]}},{name:"get_page_products",description:"Get all products currently displayed on the page",inputSchema:{type:"object",properties:{}}},{name:"add_to_cart",description:"Add a product to the shopping cart",inputSchema:{type:"object",properties:{product:{type:"object",description:"Product object with link property"},quantity:{type:"number",description:"Quantity to add (default: 1)"}},required:["product"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return await this.search(t.query);case"filter_products":return await this.applyFilters(t.filters);case"get_page_products":return await this.extractProducts();case"add_to_cart":return await this.addToCart(t.product,{quantity:t.quantity||1});default:return{success:!1,error:`Unknown tool: ${e}`}}}}