import{BaseSiteAdapter}from"./base-adapter.js";import{MCPResponse,STANDARD_MCP_TOOLS,ProductJsonLD}from"./mcp-interface.js";export class RoadRunnerSportsAdapter extends BaseSiteAdapter{constructor(e={}){super("roadrunnersports.com",e)}async safeExecute(e,r){try{return await e()}catch(t){return t&&t.stack&&t.stack.includes("kaynix")&&this.error("Kaynix error:",t),r||"Operation failed"}}async extractProducts(e={}){this.log("Extracting products from roadrunnersports.com...");const r=[],t=document.querySelectorAll("div.product-card--1gUX4");this.log(`Found ${t.length} product elements`);for(const n of t)try{const e={},t=n.querySelector(".product-card-name--9ffy7");e.title=t?t.textContent.trim():null;const s=n.querySelector('a[href^="/product/"]');s&&(e.url=s.href.startsWith("http")?s.href:`https://www.roadrunnersports.com${s.getAttribute("href")}`);const o=n.querySelector(".price-original--1VaFr");if(o){const r=o.textContent.trim();e.price=this.extractPrice(r)}const c=n.querySelector('img[src*="widen.net"]');e.imageUrl=c?c.src:null,e.title&&e.price&&e.url?r.push(e):this.log("Skipping product with missing fields:",{title:e.title,price:e.price,url:e.url})}catch(s){this.error("Error extracting product:",s)}return this.log(`Extracted ${r.length} products`),{products:r}}getMCPCapabilities(){return{tools:STANDARD_MCP_TOOLS}}async callMCPTool(e,r){try{switch(this.log(`Calling MCP tool: ${e}`,r),e){case"get_page_products":const t=await this.extractProducts();if(t.products&&t.products.length>0){const e=t.products.map(e=>new ProductJsonLD(e));return MCPResponse.success(`Found ${e.length} products`,e)}return MCPResponse.error("No products found on page");case"apply_filter_gender":const s=r.gender||r.value||r.filters?.gender;return s?await this.applyGenderFilter(s):MCPResponse.error("Gender parameter is required");case"apply_filter_price_max":return await this.applyPriceFilter(r.value);case"apply_filter_brand":return await this.applyBrandFilter(r.value);case"clear_filters":return await this.clearFilters();case"search_products":return await this.searchProducts(r.query);case"add_to_cart":return MCPResponse.error("Add to cart not yet implemented for Road Runner Sports");default:return MCPResponse.error(`Unknown tool: ${e}`)}}catch(t){const r=t instanceof Error?t.message:String(t);return this.error(`Tool ${e} failed:`,t),MCPResponse.error(`Tool execution failed: ${r}`)}}async applyGenderFilter(e){try{if(!e||"string"!=typeof e)return MCPResponse.error(`Invalid gender parameter: ${e}`);const r={men:"Men",women:"Women",kids:"Kids"}[e.toLowerCase()];if(!r)return MCPResponse.error(`Invalid gender: ${e}. Use 'men', 'women', or 'kids'`);this.log(`Looking for ${r} gender filter...`);const t=document.querySelectorAll("label");for(const e of t){const t=e.textContent.trim();if(t.startsWith(`${r}'s`)||t===r){const t=e.querySelector('input[type="checkbox"]');if(t&&!t.checked)return this.log(`Found unchecked ${r} checkbox, clicking...`),await this.safeExecute(async()=>{const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});t.dispatchEvent(e),t.checked=!0;const r=new Event("change",{bubbles:!0});t.dispatchEvent(r),await new Promise(e=>setTimeout(e,2e3))}),MCPResponse.success(`Applied ${r} filter`);if(t&&t.checked)return MCPResponse.success(`${r} filter is already applied`)}}const s=Array.from(document.querySelectorAll("h2, h3, div")).find(e=>"Gender"===e.textContent.trim());if(s){const e=s.closest("div").parentElement.querySelectorAll('input[type="checkbox"]');for(const t of e){const e=t.closest("label");if(e){const s=e.textContent.trim();if(s.startsWith(`${r}'s`)||s===r)return t.checked?MCPResponse.success(`${r} filter is already applied`):(this.log(`Found ${r} checkbox in Gender section, clicking...`),await this.safeExecute(async()=>{const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});t.dispatchEvent(e),t.checked=!0;const r=new Event("change",{bubbles:!0});t.dispatchEvent(r),await new Promise(e=>setTimeout(e,2e3))}),MCPResponse.success(`Applied ${r} filter`))}}}return MCPResponse.error(`Could not find ${r} filter checkbox on page`)}catch(r){const e=r instanceof Error?r.message:String(r);return this.error("Gender filter error:",r),MCPResponse.error(`Failed to apply gender filter: ${e}`)}}async applyPriceFilter(e){try{return MCPResponse.error("Price filter not yet implemented for Road Runner Sports")}catch(r){return MCPResponse.error(`Failed to apply price filter: ${r.message}`)}}async applyBrandFilter(e){try{return MCPResponse.error("Brand filter not yet implemented for Road Runner Sports")}catch(r){return MCPResponse.error(`Failed to apply brand filter: ${r.message}`)}}async clearFilters(){try{const e=document.querySelectorAll("button, a");for(const r of e){const e=r.textContent.toLowerCase();if(e.includes("clear")&&(e.includes("filter")||e.includes("all")))return r.click(),await new Promise(e=>setTimeout(e,1e3)),MCPResponse.success("Cleared all filters")}return MCPResponse.error("Could not find clear filters button")}catch(e){return MCPResponse.error(`Failed to clear filters: ${e.message}`)}}async searchProducts(e){try{const r=document.querySelector('input[type="search"], input[placeholder*="Search"]');if(!r)return MCPResponse.error("Could not find search input");r.value=e,r.dispatchEvent(new Event("input",{bubbles:!0}));const t=r.closest("form");return t?t.submit():r.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",keyCode:13})),MCPResponse.success(`Searching for: ${e}`)}catch(r){return MCPResponse.error(`Failed to search: ${r.message}`)}}}export default RoadRunnerSportsAdapter;