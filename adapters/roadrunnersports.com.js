import{BaseSiteAdapter}from"./base-adapter.js";export default class RoadrunnersportscomAdapter extends BaseSiteAdapter{constructor(){super("roadrunnersports.com",{productItemSelector:'div[class*="product-card--"]',searchInputSelector:'input[placeholder*="What are you looking for?"]'})}async extractProducts(e={}){if(window.location.search.includes("r=")){this.log("Filters detected in URL, extracting products from DOM instead of __NEXT_DATA__.");try{const e=document.querySelectorAll(this.config.productItemSelector),t=[];return e.forEach((e,s)=>{try{const r=e.querySelector('h2, h3, h4, [class*="product-name"], [class*="product-title"]'),i=r?r.textContent.trim():"",a=e.querySelector('[class*="price"], [class*="cost"], span[aria-label*="price"]');let o=null;if(a){const e=a.textContent.trim().match(/[\d,]+\.?\d*/);e&&(o=parseFloat(e[0].replace(/,/g,"")))}const n=e.querySelector("a"),c=n?n.href:"",l=e.querySelector("img"),u=l?l.src:null;let d="";const p=i.match(/^(Men's |Women's )?([\w\s]+?)\s/);p&&(d=p[2]),i&&t.push({position:s+1,title:i,url:c,image:u,brand:d,price:o,sku:e.getAttribute("data-sku")||""})}catch(r){this.warn(`Error extracting product ${s}: ${r.message}`)}}),this.log(`Extracted ${t.length} products from DOM`),{success:!0,products:t}}catch(t){return this.warn(`Error extracting products from DOM: ${t.message}`),{success:!1,products:[]}}}this.log("Extracting products from __NEXT_DATA__.");try{const e=this.getNextData();if(!e)throw new Error("Could not find or parse __NEXT_DATA__ script tag.");const t=e.props?.initialState?.search?.results;if(!t||!Array.isArray(t))return this.warn("Could not find products array in __NEXT_DATA__ at expected path."),{success:!1,products:[]};return{success:!0,products:t.map((e,t)=>({position:t+1,title:e.name,url:`${window.location.origin}${e.url}`,image:e.colorsSkus?.[0]?.imageId?`https://roadrunnersports.widen.net/content/${e.colorsSkus[0].imageId.split(",")[0]}?w=600`:null,brand:e.brand,price:e.price?.[0]?.amount?parseFloat(e.price[0].amount):null,sku:e.sku}))}}catch(t){return this.warn(`Error extracting products from JSON: ${t.message}`),{success:!1,products:[]}}}async extractAvailableFilters(){this.log("Extracting filters from __NEXT_DATA__.");try{const e=this.getNextData();if(!e)throw new Error("Could not find or parse __NEXT_DATA__ script tag.");const t=e.props?.initialState?.search?.refinements;if(!t)throw new Error("Could not find filters object in __NEXT_DATA__ at expected path.");const s={};for(const[i,a]of Object.entries(t))if(Array.isArray(a)&&a.length>0){const e=this.mapHeaderToGroupName(i);s[e]||(s[e]=[]);const t=a.map(e=>({label:`${e.name}${e.products?` (${e.products})`:""}`,value:e.url,count:e.products||null,isChecked:"active"===e.state}));s[e].push(...t)}const r=e.props?.initialState?.search?.sorting;return s.sortOptions=[],r&&Array.isArray(r)&&r.forEach(e=>{s.sortOptions.push({label:e.name,value:e.url,isSelected:"active"===e.state})}),s}catch(e){return this.warn(`Error extracting filters from JSON: ${e.message}`),{error:e.message}}}getNextData(){const e=document.getElementById("__NEXT_DATA__");if(!e)return null;try{return JSON.parse(e.textContent)}catch(t){return this.warn(`Failed to parse __NEXT_DATA__: ${t.message}`),null}}async navigateClientSide(e){try{const t=document.querySelector(`a[href="${e}"], a[href="${e.replace(window.location.origin,"")}"]`);if(t)return this.log("Found existing link for client-side navigation"),t.click(),!0;const s=document.createElement("a");s.href=e,s.style.display="none",document.body.appendChild(s);const r=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return s.dispatchEvent(r),setTimeout(()=>{document.body.removeChild(s)},100),this.log("Attempted client-side navigation via temporary link"),new Promise(e=>{const t=window.location.href;setTimeout(()=>{window.location.href!==t?e(!0):e(!1)},50)})}catch(t){return this.warn(`Client-side navigation failed: ${t.message}`),!1}}mapHeaderToGroupName(e){const t=e.toLowerCase();return t.includes("brand")?"brands":t.includes("color")?"colors":t.includes("shoe size")?"sizes":t.includes("width")?"widths":t.includes("size")?"sizes":t.includes("price")?"priceRanges":t.includes("category")?"categories":t.includes("support")?"supportLevels":t.includes("cushion")?"cushionLevels":t.includes("sale")?"deals":t.includes("new")?"newArrivals":t.includes("outlet")?"outlet":"categories"}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on Road Runner Sports",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query for products"}},required:["query"]}},{name:"apply_filters",description:"Apply or clear filters on product results. To clear all filters, pass an empty filters object {}",inputSchema:{type:"object",properties:{filters:{type:"object",description:"Filters to apply (e.g., {brands: ['Brooks'], sizes: ['10'], widths: ['Men's Wide']})",properties:{brands:{type:"array",items:{type:"string"}},sizes:{type:"array",items:{type:"string"}},widths:{type:"array",items:{type:"string"}},colors:{type:"array",items:{type:"string"}},categories:{type:"array",items:{type:"string"}},priceRanges:{type:"array",items:{type:"string"}}}}},required:["filters"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":const r=`https://www.roadrunnersports.com/search?q=${encodeURIComponent(t.query)}`;return await this.navigateClientSide(r)?{success:!0,message:`Navigating to search results for "${t.query}"`,navigationMethod:"client-side"}:(window.location.href=r,{success:!0,message:`Navigating to search results for "${t.query}"`,navigationMethod:"full-reload"});case"apply_filters":if(!t.filters)return{success:!1,error:"No filters provided"};try{const e=t.filters;if(0===Object.keys(e).length){const e=`${window.location.origin}/category/mens`;return this.log("Clearing all filters - navigating to base category"),await this.navigateClientSide(e)?{success:!0,message:"Cleared all filters",navigatedTo:e,action:"clear_filters",navigationMethod:"client-side"}:(window.location.href=e,{success:!0,message:"Cleared all filters",navigatedTo:e,action:"clear_filters",navigationMethod:"full-reload"})}const s=await this.extractAvailableFilters();if(s.error)return{success:!1,error:s.error};let r="/category/mens";const i=[],a=[];if(e.brands&&e.brands.length>0){r+=`/${e.brands[0].toLowerCase()}`,a.push(`brand: ${e.brands[0]}`)}if(e.colors&&e.colors.length>0){const t=e.colors[0].toLowerCase();if(s.colors){const i=s.colors.find(e=>e.label.toLowerCase().includes(t));if(i&&i.value&&i.value.startsWith("/")){r+=`/${i.value.split("/").pop()}`,a.push(`color: ${e.colors[0]}`)}}}if(e.sizes&&e.sizes.length>0&&e.sizes.forEach(e=>{const t=[...s.sizes||[]].find(t=>t.label.startsWith(e+" ")||t.label===e);if(t&&t.value){const s=t.value.match(/[?&](r=[^&]+)/);s&&(i.push(s[1]),a.push(`size: ${e}`))}}),e.widths&&e.widths.length>0&&e.widths.forEach(e=>{if(s.widths){const t=s.widths.find(t=>t.label===e||t.label.includes(e));if(t&&t.value){const s=t.value.match(/[?&](r=[^&]+)/);s&&(i.push(s[1]),a.push(`width: ${e}`))}}}),e.priceRanges&&e.priceRanges.length>0){const t=e.priceRanges[0],r=t.match(/less\s+than\s+\$?(\d+)/i)||t.match(/under\s+\$?(\d+)/i)||t.match(/<\s*\$?(\d+)/i);if(r){const e=r[1];i.push(`r=price%3A%5B0+TO+${e}%5D`),a.push(`price: under $${e}`)}else if(s.priceRanges){const e=s.priceRanges.find(e=>e.label.toLowerCase().includes(t.toLowerCase()));if(e&&e.value){const t=e.value.match(/[?&](r=[^&]+)/);t&&(i.push(t[1]),a.push(`price: ${e.label}`))}}}if(e.categories&&e.categories.length>0){const t=e.categories[0];if(s.categories){const e=s.categories.find(e=>e.label.toLowerCase().includes(t.toLowerCase()));if(e&&e.value)if(e.value.startsWith("/"))r=e.value,a.push(`category: ${t}`);else{const s=e.value.match(/[?&](r=[^&]+)/);s&&(i.push(s[1]),a.push(`category: ${t}`))}}}if(0===a.length)return{success:!1,error:`No matching filters found for: ${JSON.stringify(e)}`,availableFilterTypes:Object.keys(s)};let o=`${window.location.origin}${r}`;return i.length>0&&(o+=`?${i.join("&")}&p=6`),this.log(`Applying ${a.length} filters: ${a.join(", ")}`),this.log(`Navigating to: ${o}`),await this.navigateClientSide(o)?{success:!0,message:`Applied filters: ${a.join(", ")}`,navigatedTo:o,filters_applied:e,appliedFilters:a,navigationMethod:"client-side"}:(window.location.href=o,{success:!0,message:`Applied filters: ${a.join(", ")}`,navigatedTo:o,filters_applied:e,appliedFilters:a,navigationMethod:"full-reload"})}catch(s){return{success:!1,error:`Failed to apply filters: ${s.message}`}}default:throw new Error(`Unknown MCP tool: ${e}`)}}}