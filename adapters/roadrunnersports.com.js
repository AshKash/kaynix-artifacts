import BaseSiteAdapter from"./base-adapter.js";export default class RoadrunnersportscomAdapter extends BaseSiteAdapter{constructor(){super("roadrunnersports.com",{searchUrl:"https://roadrunnersports.com/search?q={query}",categoryUrls:["https://roadrunnersports.com/category/womens/apparel/outerwear","https://roadrunnersports.com/category/womens/apparel/shorts","https://roadrunnersports.com/category/womens/apparel/tightsandpants","https://roadrunnersports.com/category/womens/shoes/new","https://roadrunnersports.com/category/womens/shoes/outlet","https://roadrunnersports.com/category/womens/apparel/outlet","https://roadrunnersports.com/category/womens/accessories/outlet","https://roadrunnersports.com/category/womens/shoes","https://roadrunnersports.com/category/womens/shoes/running","https://roadrunnersports.com/category/womens/shoes/trail-running","https://roadrunnersports.com/category/womens/shoes/cross-training","https://roadrunnersports.com/category/womens/shoes/racing","https://roadrunnersports.com/category/womens/shoes/sandals","https://roadrunnersports.com/category/womens/shoes/walking","https://roadrunnersports.com/category/womens/shoes/casual","https://roadrunnersports.com/category/womens/shoes/hiking","https://roadrunnersports.com/category/womens/shoes/cross-country","https://roadrunnersports.com/category/womens/shoes/court","https://roadrunnersports.com/category/womens/shoes/pickleball","https://roadrunnersports.com/category/womens/shoes/work-safety"],productItemSelector:'.product-card, .product-item, article[data-product], [data-testid*="product"], .search-result-item, .product-tile, .plp-product-card',searchInputSelector:'input[type="search"], input[name="q"], input[name="search"], input[placeholder*="search" i]',searchButtonSelector:'button[type="submit"], button[class*="search"]'})}async search(e,t={}){try{const r=this.config.searchUrl.replace("{query}",encodeURIComponent(e));await this.navigateTo(r,t),await this.waitForSelector(this.config.productItemSelector,{timeout:t.timeout||1e4});const s=await this.extractProducts(t);return{success:!0,query:e,products:s.products||[],count:s.products?.length||0}}catch(r){return{success:!1,query:e,error:r.message,products:[]}}}async extractProducts(e={}){try{const e=[];await new Promise(e=>setTimeout(e,2e3));let t=document.querySelectorAll(this.config.productItemSelector);if(0===t.length){const e=['a[href*="/product/"]','a[href*="/product/"] > div','div[class*="product-card"]','div[class*="product-list"] > div > a','div[class*="search-results"] article','div[class*="ProductCard"]','div[data-qa*="product"]'];for(const r of e)if(t=document.querySelectorAll(r),t.length>0)break}for(let r=0;r<t.length;r++){const s=t[r],o=s,c={position:r+1},a=o.querySelector('h2, h3, h4, [class*="product-name"], [class*="product-title"], [data-qa="product-name"]');a&&(c.title=this.extractText(a));const n=s.closest("a")||o.querySelector('a[href*="/product"]');if(n){const e=n.getAttribute("href");c.url=e.startsWith("http")?e:`https://roadrunnersports.com${e}`}let i=o.querySelector('.price, [class*="price"], .cost, [data-price]');if(i||(i=o.querySelector('[class*="dollar"], [class*="amount"], [class*="currency"]')),!i){const e=o.querySelectorAll("*");for(const t of e){const e=this.extractText(t);if(e&&/\$\d/.test(e)){i=t;break}}}if(i){const e=this.extractText(i);c.priceText=e,c.price=this.extractPrice(e)}const l=o.querySelector("img");l&&(c.image=l.src||l.getAttribute("data-src")),c.title&&(c.brand=this.extractBrandFromName(c.title)),c.title&&c.url&&e.push(c)}return{success:!0,products:e}}catch(t){return{success:!1,error:t.message,products:[]}}}async applyFilters(e){try{let t=0;const r=[];if(e.brands&&e.brands.length>0)for(const c of e.brands){const e=await this.findElementByText('input[type="checkbox"]',c,{exact:!1,stripCount:!0,stripSymbols:!0});e&&!e.checked?(await this.safeClick(e),await this.waitForProductUpdate(),t++):e||r.push(`Brand: ${c}`)}if(e.sizes&&e.sizes.length>0)for(const c of e.sizes){let e=null;/^\d+(\.\d+)?$/.test(c)&&(e=await this.findElementByText('input[type="checkbox"]',c,{exact:!0,stripCount:!0})),e||(e=await this.findElementByText('input[type="checkbox"]',c,{exact:!1,stripCount:!0})),e&&!e.checked?(await this.safeClick(e),await this.waitForProductUpdate(),t++):e||r.push(`Size: ${c}`)}if(e.colors&&e.colors.length>0)for(const c of e.colors){const e=await this.findElementByText('input[type="checkbox"]',c,{exact:!1,stripCount:!0});e&&!e.checked?(await this.safeClick(e),await this.waitForProductUpdate(),t++):e||r.push(`Color: ${c}`)}if(e.width){const s={wide:"Men's Wide","extra wide":"Men's Extra Wide",narrow:"Men's Narrow"}[e.width.toLowerCase()]||e.width,o=await this.findElementByText('input[type="checkbox"]',s,{exact:!1,stripCount:!0});o&&!o.checked?(await this.safeClick(o),await this.waitForProductUpdate(),t++):o||r.push(`Width: ${e.width}`)}if(e.priceMax||e.priceMin){await this.setPriceRange(e.priceMin,e.priceMax)&&(await this.waitForProductUpdate(),t++)}const s=await this.extractProducts();let o=`Applied ${t} filters`;return r.length>0&&(o+=`. Could not find: ${r.join(", ")}`),{success:!0,filtersApplied:t,filtersNotFound:r,message:o,products:s.products||[]}}catch(t){return{success:!1,error:t.message}}}async extractAvailableFilters(){try{const e={brands:[],colors:[],sizes:[],priceRanges:[],categories:[],sortOptions:[]};let t=document.querySelectorAll(".filters, .sidebar, .filter-sidebar, [data-filters], .facets, .refinements, .product-filters, .plp-filters");0===t.length&&(t=document.querySelectorAll('aside, [role="complementary"], .left-sidebar, .filter-panel, div[class*="filter"]')),0===t.length&&(t=[document.body]);for(const s of t){const t=s.querySelectorAll('input[type="checkbox"][name*="brand"], input[type="checkbox"][value*="Nike"], input[type="checkbox"][value*="Adidas"], input[type="checkbox"][value*="Brooks"], label:has(input[type="checkbox"]) + span');t.length,t.forEach(t=>{const r=this.extractText(t.parentElement||t.nextElementSibling);r&&e.brands.push({label:r,value:t.value||r.toLowerCase().replace(/\s+/g,"-"),isChecked:t.checked||!1,count:this.extractCountFromLabel(r)})});const r=s.querySelector('[data-filter="size"], .size-filter, .sizes');if(r){r.querySelectorAll('input[type="checkbox"], .filter-option, .size-option').forEach(t=>{const r=this.extractText(t.parentElement||t.nextElementSibling);r&&e.sizes.push({label:r,value:t.value||r.toLowerCase(),isChecked:t.checked||!1,count:this.extractCountFromLabel(r)})})}const o=s.querySelector('[data-filter="color"], .color-filter, .colors');if(o){o.querySelectorAll('input[type="checkbox"], .filter-option, .color-option').forEach(t=>{const r=this.extractText(t.parentElement||t.nextElementSibling);r&&e.colors.push({label:r,value:t.value||r.toLowerCase(),isChecked:t.checked||!1,count:this.extractCountFromLabel(r)})})}}if(0===e.brands.length&&0===e.sizes.length&&0===e.colors.length){document.querySelectorAll('input[type="checkbox"]').forEach(t=>{const r=this.extractText(t.parentElement)||this.extractText(t.nextElementSibling)||t.getAttribute("aria-label")||t.value;if(r&&r.length>0&&r.length<50){const s=r.toLowerCase();s.match(/^(xs|s|m|l|xl|xxl|\d+(\.\d+)?|small|medium|large)$/i)?e.sizes.push({label:r,value:t.value||r,isChecked:t.checked,count:this.extractCountFromLabel(r)}):s.match(/(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown)/i)?e.colors.push({label:r,value:t.value||r,isChecked:t.checked,count:this.extractCountFromLabel(r)}):s.match(/(nike|adidas|brooks|asics|saucony|new balance|hoka|under armour)/i)&&e.brands.push({label:r,value:t.value||r,isChecked:t.checked,count:this.extractCountFromLabel(r)})}})}const r=document.querySelector('select[name*="sort"], .sort-select, #sort-options');if(r){r.querySelectorAll("option").forEach(t=>{t.value&&t.textContent.trim()&&e.sortOptions.push({label:t.textContent.trim(),value:t.value})})}return e}catch(e){return{brands:[],colors:[],sizes:[],priceRanges:[],categories:[],sortOptions:[]}}}extractCountFromLabel(e){const t=e.match(/\((\d+)\)/);return t?parseInt(t[1]):null}extractBrandFromName(e){const t=["Nike","Adidas","Brooks","ASICS","Saucony","New Balance","HOKA","Under Armour"];for(const r of t)if(e.toLowerCase().includes(r.toLowerCase()))return r;return""}async clearFilters(){try{const e=document.querySelectorAll('button[class*="clear-all"], button[class*="reset"], a[class*="clear-all"], button:contains("Clear")');for(const s of e)if(this.extractText(s).toLowerCase().includes("clear"))return await this.safeClick(s),await this.waitForProductUpdate(),{success:!0,message:"Filters cleared"};const t=document.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked');let r=0;for(const s of t)await this.safeClick(s),r++,r%5==0&&await this.waitForProductUpdate();return r>0&&await this.waitForProductUpdate(),{success:!0,message:`Cleared ${r} filters`,filtersCleared:r}}catch(e){return{success:!1,error:e.message}}}getFilterState(){const e={brands:[],sizes:[],colors:[],widths:[],priceRange:null,sortBy:null};document.querySelectorAll('input[type="checkbox"]:checked').forEach(t=>{const r=this.extractText(t.parentElement)||this.extractText(t.nextElementSibling)||t.value,s=t.closest('[data-filter-type], [class*="filter"]'),o=s?this.extractText(s).toLowerCase():"";o.includes("brand")||r.match(/nike|adidas|brooks|asics/i)?e.brands.push(r):o.includes("size")||r.match(/^\d+(\.\d+)?$/)?e.sizes.push(r):o.includes("color")||r.match(/black|white|red|blue/i)?e.colors.push(r):(o.includes("width")||r.includes("Wide"))&&e.widths.push(r)});const t=document.querySelector('select[name*="sort"], .sort-select');return t&&(e.sortBy=t.value),e}async sortBy(e){try{const t=document.querySelector('select[name*="sort"], .sort-select, #sort-options');if(!t)return{success:!1,error:"Sort dropdown not found"};const r={"price-low":"price-asc","price-high":"price-desc",rating:"rating-desc",newest:"newest",bestselling:"best-sellers"}[e]||e;return await this.selectDropdownOption(t,r)?(await this.waitForProductUpdate(),{success:!0,message:`Sorted by ${e}`}):{success:!1,error:`Sort option '${e}' not found`}}catch(t){return{success:!1,error:t.message}}}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on Road Runner Sports",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query for products"}},required:["query"]}},{name:"apply_filters",description:"Apply filters like brand, size, color to refine products",inputSchema:{type:"object",properties:{filters:{type:"object",properties:{brands:{type:"array",items:{type:"string"}},sizes:{type:"array",items:{type:"string"}},colors:{type:"array",items:{type:"string"}}}}},required:["filters"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return await this.search(t.query);case"apply_filters":return await this.applyFilters(t.filters);default:throw new Error(`Unknown MCP tool: ${e}`)}}getVersion(){const e=(new Date).toLocaleString("en-US",{timeZone:"America/Los_Angeles",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/(\d+)\/(\d+)\/(\d+),\s(.+)/,"$3-$1-$2 $4"),t=this.constructor.toString().split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);return`roadrunner-v2.4-${e} PST [hash:${Math.abs(t)}]`}}