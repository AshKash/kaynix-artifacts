import{BaseSiteAdapter,STANDARD_MCP_TOOLS,ProductJsonLD,MCPResponse}from"./base-adapter.js";export default class ShopwarriorscomAdapter extends BaseSiteAdapter{constructor(e={}){super("shop.warriors.com",e),this.debug=e.debug||!1,this.selectors={filters:{container:".filter-selector-container",section:".filter-selector",item:".filter-selector-item",link:".filter-selector-link.selection-value",customContainer:".custom-filters-container",customList:".custom-filters-list",toggle:".filters-toggle-button",sideNav:{container:".side-nav-container",component:".side-nav-component",selections:".side-nav-selections",facetItems:".side-nav-facet-items",productGroups:".side-nav-facet-items.productGroups"},checkboxFilters:{size:'input[name="filter.v.option.size"]',color:'input[name="filter.v.option.color"]',price:'input[name="filter.v.price"]',productType:'input[name="filter.p.product_type"]',team:'input[name="filter.v.option.team"]',player:'input[name="filter.v.option.player"]',brand:'input[name="filter.v.option.brand"]',material:'input[name="filter.v.option.material"]',style:'input[name="filter.v.option.style"]',gender:'input[name="filter.v.option.gender"]'}},products:{gridContainer:".product-grid-container",grid:".layout-row.product-grid",item:".product-card.row",title:".product-card-title",image:".product-image",imageContainer:".product-image-container",price:".product-card-price",badges:".product-badges-container",badge:".flag.product-badge-flag",colors:".product-card-colors",vibrancy:".product-vibrancy",count:".product-count",dataGrid:'[data-trk-id="product-grid"]'},search:{form:'[data-trk-id="search-typeahead"]',input:'input[type="search"], input[type="text"]',searchButton:"#ds-search",searchIcon:".icon-search",typeahead:".mobile-typeahead",typeaheadItem:".typeahead-item",closeSearch:'[data-trk-id="close-search-box"]'},cart:{addButton:".button.primary",sizeSelector:".size-selector-button",cartIcon:".cart-icon",cartCount:".cart-icon .cart-count",cartLink:'a[href*="/cart"]'}}}async search(e){try{if(this.page){await this.page.waitForSelector(this.selectors.search.form,{timeout:5e3});if(!await this.page.$(this.selectors.search.input)){const e=await this.page.$(this.selectors.search.searchButton);e&&(await e.click(),await this.page.waitForSelector(this.selectors.search.input,{timeout:3e3}))}await this.page.fill(this.selectors.search.input,e),await this.page.keyboard.press("Enter"),await this.waitForPageLoad();return{success:!0,products:(await this.extractProducts()).products||[],query:e}}{const t=document.querySelector(this.selectors.search.input);if(!t){const t=document.querySelector(this.selectors.search.searchButton);if(!t)return window.location.href=`/search?q=${encodeURIComponent(e)}`,{success:!0,products:[],query:e};t.click(),await new Promise(e=>setTimeout(e,500))}if(t){t.value=e;const r=t.closest("form");r?r.submit():t.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter"}))}return{success:!0,products:[],query:e}}}catch(t){return{success:!1,products:[],query:e,error:t.message}}}async applyFilters(e){try{let t=e;"string"==typeof e&&(t=this.parseNaturalLanguageFilters(e));const r=[];if(this.page){for(const[e,s]of Object.entries(t)){const t=this.selectors.filters.checkboxFilters[e];if(!t)continue;const a=await this.page.$$(t);for(const o of a){const t=await o.getAttribute("value"),a=await o.evaluate(e=>{const t=e.parentElement.querySelector("label")||e.closest("label");return t?t.textContent.trim():""});if(t===s||t?.toLowerCase()===s.toLowerCase()||a?.toLowerCase().includes(s.toLowerCase())){await o.click(),r.push({type:e,value:s});break}}}await this.waitForPageLoad()}else for(const[e,s]of Object.entries(t)){const t=this.selectors.filters.checkboxFilters[e];if(!t)continue;const a=document.querySelectorAll(t);for(const o of a){const t=o.value,a=o.parentElement.querySelector("label")||o.closest("label"),i=a?a.textContent.trim():"";if(t===s||t?.toLowerCase()===s.toLowerCase()||i?.toLowerCase().includes(s.toLowerCase())){o.click(),r.push({type:e,value:s});break}}}return{success:!0,appliedFilters:r,products:(await this.extractProducts()).products||[]}}catch(t){return{success:!1,appliedFilters:[],products:[],error:t.message}}}async extractProducts(){try{if(this.page){return{success:!0,products:await this.page.evaluate(e=>{const t=document.querySelectorAll(e.products.item);return Array.from(t).map(t=>{const r=t.querySelector(e.products.title),s=t.querySelector(e.products.price)||t.querySelector(".product-card-price"),a=t.querySelector(e.products.image),o=t.querySelector("a");let i="Price not available";if(s){const e=s.textContent.match(/\$[\d,]+\.?\d*/);e&&(i=e[0])}return{title:r?.textContent?.trim()||"No title",price:i,image:a?.src||a?.getAttribute("data-src")||"",link:o?.href||"",available:!t.classList.contains("sold-out")}})},this.selectors)}}{const e=document.querySelectorAll(this.selectors.products.item);return{success:!0,products:Array.from(e).map(e=>{const t=e.querySelector(this.selectors.products.title),r=e.querySelector(this.selectors.products.price)||e.querySelector(".product-card-price"),s=e.querySelector(this.selectors.products.image),a=e.querySelector("a");let o="Price not available";if(r){const e=r.textContent.match(/\$[\d,]+\.?\d*/);e&&(o=e[0])}return{title:t?.textContent?.trim()||"No title",price:o,image:s?.src||s?.getAttribute("data-src")||"",link:a?.href||"",available:!e.classList.contains("sold-out")}})}}}catch(e){return{success:!1,products:[],error:e.message}}}async addToCart(e,t={}){try{const r=t.size||"M";t.quantity;if(this.page){await this.page.goto(e.link),await this.page.waitForSelector(this.selectors.cart.sizeSelector);const t=await this.page.$$(this.selectors.cart.sizeSelector);for(const e of t){if((await e.textContent()).includes(r)){await e.click();break}}return await this.page.click(this.selectors.cart.addButton),await this.page.waitForTimeout(2e3),{success:!0,message:`Added ${e.title} (size ${r}) to cart`}}return{success:!1,message:"Add to cart not available in widget mode"}}catch(r){return{success:!1,message:r.message}}}async waitForPageLoad(){this.page?(await this.page.waitForLoadState("networkidle",{timeout:1e4}),await this.page.waitForTimeout(1e3)):await new Promise(e=>setTimeout(e,2e3))}async getAvailableFilters(){const e={sizes:[],colors:[],players:[],teams:[],brands:[],productTypes:[],materials:[],styles:[],genders:[],priceRange:{min:0,max:500}};try{const t={size:"sizes",color:"colors",player:"players",team:"teams",brand:"brands",productType:"productTypes",material:"materials",style:"styles",gender:"genders"};for(const[r,s]of Object.entries(this.selectors.filters.checkboxFilters)){if("price"===r)continue;const a=this.page?await this.page.$$(s):document.querySelectorAll(s),o=[];for(const e of a)if(this.page){const t=await e.getAttribute("value"),r=await e.evaluate(e=>{const t=e.parentElement.querySelector("label")||e.closest("label");return t?t.textContent.trim():""});(t||r)&&o.push(r||t)}else{const t=e.value,r=e.parentElement.querySelector("label")||e.closest("label"),s=r?r.textContent.trim():"";(t||s)&&o.push(s||t)}const i=t[r];i&&o.length>0&&(e[i]=[...new Set(o)])}return e}catch(t){return e}}parseNaturalLanguageFilters(e){const t={},r=e.toLowerCase(),s=r.match(/size\s+(\w+)|(\w+)\s+size|small|medium|large|x{0,2}l|x{0,2}s/);if(s){const e={small:"S",s:"S",medium:"M",m:"M",large:"L",l:"L",xl:"XL",xxl:"XXL",xs:"XS",xxs:"XXS"},r=s[1]||s[2]||s[0];t.size=e[r.toLowerCase()]||r.toUpperCase()}const a=["red","blue","black","white","gray","green","yellow","purple","orange","gold"];for(const c of a)if(r.includes(c)){t.color=c.charAt(0).toUpperCase()+c.slice(1);break}const o=r.match(/under\s+\$?(\d+)|less\s+than\s+\$?(\d+)|\$?(\d+)\s+or\s+less/);o&&(t.priceMax=parseInt(o[1]||o[2]||o[3]));const i=r.match(/curry|thompson|green|wiggins|poole/i);return i&&(t.player=i[0].charAt(0).toUpperCase()+i[0].slice(1)),r.includes("jersey")&&(t.productType="Jersey"),r.includes("shirt")&&(t.productType="Shirt"),r.includes("shorts")&&(t.productType="Shorts"),(r.includes("hat")||r.includes("cap"))&&(t.productType="Hat"),t}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on Warriors Shop",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query (e.g., 'Curry jersey', 'Warriors shorts')"}},required:["query"]}},{name:"filter_products",description:"Filter products by various attributes",inputSchema:{type:"object",properties:{filters:{type:"string",description:"Natural language filters (e.g., 'size L blue under $50', 'Curry jerseys')"}},required:["filters"]}},{name:"get_page_products",description:"Get all products currently displayed on the page",inputSchema:{type:"object",properties:{}}},{name:"add_to_cart",description:"Add a product to the shopping cart",inputSchema:{type:"object",properties:{productUrl:{type:"string",description:"URL of the product to add"},size:{type:"string",description:"Size option (e.g., 'M', 'L', 'XL')"},quantity:{type:"number",description:"Quantity to add (default: 1)"}},required:["productUrl"]}}]}}async callMCPTool(e,t){switch(e){case"search_products":return await this.search(t.query);case"filter_products":return await this.applyFilters(t.filters);case"get_page_products":return await this.extractProducts();case"add_to_cart":const r={link:t.productUrl,title:"Product"};return await this.addToCart(r,{size:t.size||"M",quantity:t.quantity||1});default:return{success:!1,error:`Unknown tool: ${e}`}}}}