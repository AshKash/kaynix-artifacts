import{BaseSiteAdapter}from"./base-adapter.js";export class ShopwarriorscomAdapter extends BaseSiteAdapter{constructor(e={}){super("shop.warriors.com",e),this.log("Adapter initialized")}async search(e,t={}){this.log(`Searching for: ${e}`);try{const t=`https://shop.warriors.com/?query=${encodeURIComponent(e)}`;this.log(`Navigating to search URL: ${t}`),window.location.href=t,await this.sleep(2e3),await this.waitForProductUpdate();const r=await this.extractProducts(),i=window.location.href.includes("query=")||window.location.search.includes("query=")||document.title.toLowerCase().includes("search");return{success:!0,message:`Found ${r.products.length} results for '${e}'`,query:e,products:r.products,count:r.products.length,isSearchPage:i,searchUrl:t}}catch(r){return this.error("Search error:",r),{success:!1,message:`Search failed: ${r.message}`,query:e,error:r.message}}}async extractProducts(e={}){this.log("Extracting products");try{await this.sleep(1e3);const e=[];return document.querySelectorAll(".product-card").forEach((t,r)=>{try{const i=t.querySelector("a"),a=this.extractText(t.querySelector('[class*="title"]')),s=this.extractText(t.querySelector('.price, [class*="price"]')),l=(this.extractPrice(s),i?.href),o=t.querySelector("img")?.src;if(!a||!l)return void this.log("Skipping product with missing data");e.push({title:a,price:s||"Price not available",link:l,image:o||"",available:!0,position:r+1})}catch(i){this.log(`Error extracting product: ${i.message}`)}}),this.log(`Found ${e.length} products`),{success:!0,message:`Found ${e.length} products`,products:e}}catch(t){return this.error("Extract products error:",t),{success:!1,message:`Failed to extract products: ${t.message}`,products:[]}}}async applyFilters(e={}){this.log("Applying filters:",e);let t=0;const r=[];try{const i=await this.extractAvailableFilters(),a=async(e,t)=>{const r=(i[e]||[]).find(e=>{const r="string"==typeof t?t:t.label||t.value,i=e.label===r||e.label.toLowerCase()===r.toLowerCase(),a=!i&&e.label.toLowerCase().startsWith(r.toLowerCase()+" ");return i||a});if(r&&r.value){this.log(`Applying ${e} filter: ${r.label}`);let t=null;if(t=document.querySelector(`a[href="${r.value}"]`),!t){const e=document.querySelectorAll("a.facet-link");t=Array.from(e).find(e=>e.href===r.value||e.href===r.fullUrl||e.getAttribute("href")===r.value||e.textContent.trim()===r.label)}if(t)return{shouldNavigate:!0,url:t.href,filterType:e,filterValue:r.label};this.warn(`Could not find link element for filter: ${r.label}`)}return!1};if(e.sizes&&e.sizes.length>0){const t=await a("sizes",e.sizes[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied size filter: ${e.sizes[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}if(e.colors&&e.colors.length>0){const t=await a("colors",e.colors[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied color filter: ${e.colors[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}if(e.brands&&e.brands.length>0){const t=await a("brands",e.brands[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied brand filter: ${e.brands[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}if(e.players&&e.players.length>0){const t=await a("players",e.players[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied player filter: ${e.players[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}if(e.productTypes&&e.productTypes.length>0){const t=await a("productTypes",e.productTypes[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied product type filter: ${e.productTypes[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}if(e.genderAge&&e.genderAge.length>0){const t=await a("genderAge",e.genderAge[0]);if(t&&t.shouldNavigate)return{success:!0,message:`Applied gender/age filter: ${e.genderAge[0]}`,filtersApplied:1,appliedFilters:[{type:t.filterType,value:t.filterValue}],navigationRequired:!0,navigateUrl:t.url,note:"Navigation-based filtering - page will reload"}}const s=["sizes","colors","brands","players","productTypes","genderAge","priceRange","minPrice","maxPrice"];for(const t of Object.keys(e))if(!s.includes(t)&&Array.isArray(e[t])&&e[t].length>0){this.log(`Applying dynamic filter category: ${t}`);const r=await a(t,e[t][0]);if(r&&r.shouldNavigate)return{success:!0,message:`Applied ${t} filter: ${e[t][0]}`,filtersApplied:1,appliedFilters:[{type:r.filterType,value:r.filterValue}],navigationRequired:!0,navigateUrl:r.url,note:"Navigation-based filtering - page will reload"}}if(e.priceRange||e.minPrice||e.maxPrice){const i=document.querySelector('input[name*="min"][name*="price"], input[placeholder*="min" i]'),a=document.querySelector('input[name*="max"][name*="price"], input[placeholder*="max" i]');if(i&&(e.minPrice||e.priceRange?.min)){const a=e.minPrice||e.priceRange.min;i.value=a,i.dispatchEvent(new Event("change",{bubbles:!0})),t++,r.push({type:"minPrice",value:a})}if(a&&(e.maxPrice||e.priceRange?.max)){const i=e.maxPrice||e.priceRange.max;a.value=i,a.dispatchEvent(new Event("change",{bubbles:!0})),t++,r.push({type:"maxPrice",value:i})}const s=document.querySelector('button[class*="apply"], button[type="submit"]');s&&(i||a)&&(await this.safeClick(s),await this.sleep(1e3))}t>0&&(this.log(`Waiting for products to update after applying ${t} filters`),await this.waitForProductUpdate());return{success:!0,message:`Applied ${t} filters`,filtersApplied:t,appliedFilters:r,products:(await this.extractProducts()).products}}catch(i){return this.error("Error applying filters:",i),{success:!1,message:`Error applying filters: ${i.message}`,filtersApplied:t,appliedFilters:r}}}async extractAvailableFilters(){this.log("Extracting available filters...");const e={brands:[],colors:[],sizes:[],priceRanges:[],players:[],productTypes:[],genderAge:[]};try{await this.sleep(1e3);const t=document.querySelector(".side-nav-component");if(!t)return this.log("No filter container found - might not be on a category page"),e;t.querySelectorAll(".side-nav-facet").forEach(t=>{const r=t.querySelector(".side-nav-facet-heading"),i=r?this.extractText(r):"",a=[],s=e=>{if("A"===e.tagName&&(e.classList.contains("facet-link")||e.href?.includes("filter")||e.href?.includes("facet"))){const t=this.extractText(e).trim();t&&a.push({label:t,value:e.getAttribute("href")||e.href||t,fullUrl:e.href,isChecked:!1,count:this.extractCountFromLabel(t)})}for(const t of e.children)s(t)};s(t),a.length>0&&this.log(`Found ${a.length} filters in section "${i}":`,a.map(e=>e.label)),a.forEach(t=>{if(!this.categorizeFilter(t,e,i)){const r=this.normalizeSectionTitle(i);r&&!e[r]&&(e[r]=[]),r&&e[r].push(t)}})});const r=document.querySelectorAll('input[name*="price"], input[type="range"], input[placeholder*="min"], input[placeholder*="max"]');if(r.length>=2){const t=Array.from(r).find(e=>e.name?.includes("min")||e.placeholder?.toLowerCase().includes("min")||e.getAttribute("aria-label")?.toLowerCase().includes("min")),i=Array.from(r).find(e=>e.name?.includes("max")||e.placeholder?.toLowerCase().includes("max")||e.getAttribute("aria-label")?.toLowerCase().includes("max"));t&&i&&e.priceRanges.push({label:"Custom Price Range",min:parseFloat(t.min||0),max:parseFloat(i.max||1e3),currentMin:parseFloat(t.value||t.min||0),currentMax:parseFloat(i.value||i.max||1e3)})}Object.keys(e).forEach(t=>{if(Array.isArray(e[t])){const r=new Set;e[t]=e[t].filter(e=>{const t=e.label||e.value;return!r.has(t)&&(r.add(t),!0)})}});const i={};return Object.keys(e).forEach(t=>{Array.isArray(e[t])&&e[t].length>0&&(i[t]=e[t].length)}),this.log("Found filters:",i),e}catch(t){return this.error("Error extracting filters:",t),e}}categorizeFilter(e,t,r=""){const i=e.label.toLowerCase(),a=r.toLowerCase();return a.includes("size")?(t.sizes.push(e),!0):a.includes("gender")||a.includes("age")?(t.genderAge.push(e),!0):a.includes("department")||a.includes("sub department")?(t.productTypes.push(e),!0):a.includes("brand")?(t.brands.push(e),!0):a.includes("player")?(t.players.push(e),!0):a.includes("collection")?(t.brands.push(e),!0):this.isSizePattern&&this.isSizePattern(i)||i.match(/^(xs|s|m|l|xl|xxl|2xl|3xl|4xl|5xl|[0-9]+)$/)?(t.sizes.push(e),!0):this.isColorPattern&&this.isColorPattern(i)?(t.colors.push(e),!0):i.match(/curry|thompson|green|wiggins|poole|kuminga|payton|looney/)?(t.players.push(e),!0):i.match(/jersey|hoodie|sweatshirt|t-shirt|tee|jacket|shorts|hat|cap/)?(t.productTypes.push(e),!0):this.isBrandPattern&&this.isBrandPattern(i)||i.match(/nike|adidas|mitchell|fanatics|jordan|champion|new era/)?(t.brands.push(e),!0):!!i.match(/^(men|women|kids|baby|boys|girls|youth|toddler|infant)$/)&&(t.genderAge.push(e),!0)}normalizeSectionTitle(e){return e?e.toLowerCase().replace(/[^a-z0-9\s]/g,"").split(/\s+/).map((e,t)=>0===t?e:e.charAt(0).toUpperCase()+e.slice(1)).join(""):""}getMCPCapabilities(){return{tools:[{name:"search_products",description:"Search for products on shop.warriors.com",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query"}},required:["query"]}},{name:"apply_filters",description:"Apply filters to product listing",inputSchema:{type:"object",properties:{filters:{type:"object",description:"Filters to apply (e.g. {sizes: ['M'], colors: ['Blue']})"}},required:["filters"]}}]}}async callMCPTool(e,t){switch(this.log(`MCP tool called: ${e}`,t),e){case"search_products":return this.search(t.query);case"apply_filters":return this.applyFilters(t.filters);default:throw new Error(`Unknown MCP tool: ${e}. Available tools: search_products, apply_filters`)}}}export default ShopwarriorscomAdapter;